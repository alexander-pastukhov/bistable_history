<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bistablehistory">
<title>Writing Stan code â€¢ bistablehistory</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Writing Stan code">
<meta property="og:description" content="bistablehistory">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">bistablehistory</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cumulative-history.html">Cumulative History</a>
    <a class="dropdown-item" href="../articles/usage-examples.html">Usage examples</a>
    <a class="dropdown-item" href="../articles/writing-stan-code.html">Writing Stan code</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/alexander-pastukhov/bistablehistory/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Writing Stan code</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/alexander-pastukhov/bistablehistory/blob/HEAD/vignettes/writing-stan-code.Rmd" class="external-link"><code>vignettes/writing-stan-code.Rmd</code></a></small>
      <div class="d-none name"><code>writing-stan-code.Rmd</code></div>
    </div>

    
    
<p>The package allows for only limited models as, e.g., neither random slopes, nor interaction effects are allowed. Imposing this restriction was a design decision, as it would require duplicating functionality of general purposes packages. Instead, the package itself provides some basic fitting that should be sufficient for most simple cases. However, below you will find example of how to incorporate cumulative history into a model written in Stan. This way, you can achieve maximal flexibility but still save time by reusing the code.</p>
<div class="section level2">
<h2 id="stan-model">Stan model<a class="anchor" aria-label="anchor" href="#stan-model"></a>
</h2>
<p>This is a complete Stan code for a model with log-normal distribution for multiple runs from a single experimental session of a single participant. The history time-constant <code>tau</code> is fitted, whereas constants are used for other cumulative history parameters.</p>
<pre class="stan"><code>data{
    // --- Complete time-series ---
    int&lt;lower=1&gt; rowsN;     // Number of rows in the COMPLETE multi-timeseries table including mixed phase.
    real duration[rowsN];   // Duration of a dominance/transition phase
    int istate[rowsN];      // Index of a dominance istate, 1 and 2 code for two competing clear states, 3 - transition/mixed.
    int is_used[rowsN];     // Whether history value must used to predict duration or ignored
                            // (mixed phases, warm-up period, last, etc.)
    int run_start[rowsN];   // 1 marks a beginning of the new time-series (run/block/etc.)
    real session_tmean[rowsN]; // Mean dominance phase duration for both CLEAR percepts. Used to scale time-constant.
    
    // --- A shorter clear-states only time-series ---
    int clearN;                  // Number of rows in the clear-states only time-series
    real clear_duration[clearN]; // Duration for clear percepts only.
    
    // --- Cumulative history parameters
    real&lt;lower=0, upper=1&gt; history_starting_values[2]; // Starting values for cumulative history at the beginning of the run
    real&lt;lower=0, upper=1&gt; mixed_state;                // Mixed state signal strength
}
parameters {
    real&lt;lower=0&gt; tau; // history time-constant
    
    // linear model for mu
    real a;
    real bH;
    
    // variance
    real&lt;lower=0&gt; sigma;
}
transformed parameters{
    vector[clearN] mu; // vector of computed mu for each clear percept
  
    {
        // temporary variables
        real current_history[2]; // current computed history
        real tau_H;              // tau in the units of time
        real dH;                 // computed history difference
        int iC = 1;              // Index of clear percepts used for fitting

        // matrix with signal levels
        matrix[2, 3] level = [[1, 0, mixed_state], 
                              [0, 1, mixed_state]];

        for(iT in 1:rowsN){
            // new time-series, recompute absolute tau and reset history state
            if (run_start[iT]){
                // reset history
                current_history = history_starting_values;

                // Recompute tau in units of time. 
                // This is relevant only for multiple sessions / participants.
                // However, we left this code for generality.
                tau_H = session_tmean[iT] * tau;
            }

            // for valid percepts, we use history to compute mu
            if (is_used[iT] == 1){
                // history difference
                dH = current_history[3-istate[iT]] - current_history[istate[iT]];

                // linear model for mu
                mu[iC] = a + bH * dH;
                iC += 1;
            }

            // computing history for the NEXT episode
            // see vignette on cumulative history
            for(iState in 1:2){
                current_history[iState] = level[iState, istate[iT]] + 
                  (current_history[iState] - level[iState, istate[iT]]) * exp(-duration[iT] / tau_H);
            }
        }
    }
}
model{
  // sampling individual parameters
  tau ~ lognormal(log(1), 0.75);
  a ~ normal(log(3), 5);
  bH ~ normal(0, 1);
  sigma ~ exponential(1);
  
  // sampling data using computed mu and sampled sigma
  clear_duration ~ lognormal(exp(mu), sigma);
}</code></pre>
</div>
<div class="section level2">
<h2 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h2>
<p>The <code>data</code> section defines model inputs. Hopefully, the comments make understanding it fairly straightforward. However, it has several features that although are not needed for the limited single session / single session make it easier to generalized the code for more complicated cases.</p>
<p>For example, not all dominance phases are used for fitting. Specifically, all mixed perception phases, first dominance phase for each percept (not enough time to form reliably history) and last dominance phase (curtailed by the end of the block) are excluded. Valid dominance phases are marked in <code>is_used</code> vector. Their total number is stored in <code>clearN</code> variable and the actual dominance durations in <code>clear_duration</code>. The latter is not strictly necessary but allows us to avoid a loop and vectorize the sampling statement <code>clear_duration ~ lognormal(exp(mu), sigma);</code>.</p>
<p>In addition, <code>session_tmean</code> is a vector rather than a scalar. This is not necessary for a single session example here but we opted to use as it will better generalize for more complicated cases.</p>
<p>bistability package provides a service function <code><a href="../reference/preprocess_data.html">preprocess_data()</a></code> that simplifies the process of preparing the data. However, you need to perform the last step, forming a list of inputs for Stan sampling, yourself.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># function that checks data for internal consistency and returns a preprocessed table</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">bistablehistory</span><span class="fu">::</span><span class="fu"><a href="../reference/preprocess_data.html">preprocess_data</a></span><span class="op">(</span><span class="va">br_single_subject</span>, 
                                       state<span class="op">=</span><span class="st">"State"</span>,
                                       duration<span class="op">=</span><span class="st">"Duration"</span>,
                                       run<span class="op">=</span><span class="st">"Block"</span><span class="op">)</span>

<span class="co"># data for Stan model</span>
<span class="va">stan_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  <span class="co"># complete time-series</span>
  rowsN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>,
  duration <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">duration</span>,
  istate <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">istate</span>,
  is_used <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">is_used</span>,
  run_start <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">run_start</span>,
  session_tmean <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">session_tmean</span>,
  
  <span class="co"># only valid clear percepts</span>
  clearN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">is_used</span><span class="op">)</span>,
  clear_duration <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">duration</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">is_used</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,
  
  <span class="co"># history parameters, all fixed to default values</span>
  history_starting_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
  mixed_state <span class="op">=</span> <span class="fl">0.5</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-the-model">Using the model<a class="anchor" aria-label="anchor" href="#using-the-model"></a>
</h2>
<p>You can use this model either with <code>rstan</code> or <code>cmdstanr</code> packages. Below is in an example using <code>cmdstanr</code>, assuming that model file is called <code>example.stan</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compile the model</span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/cmdstan_model.html" class="external-link">cmdstan_model</a></span><span class="op">(</span><span class="st">"example.stan"</span><span class="op">)</span>

<span class="co"># sample model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>data<span class="op">=</span><span class="va">stan_data</span>, chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span>

<span class="co"># extract posterior samples for tau parameter</span>
<span class="va">tau</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="fu">draws</span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"tau"</span><span class="op">)</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://alexander-pastukhov.github.io/" class="external-link">Alexander Pastukhov</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
